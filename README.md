## Pilot hardening checklist

Set these envs in staging/prod (via your secrets manager):

- IdP/JWT (API RS256): `JWT_ISSUER`, `JWT_AUDIENCE`, `JWT_JWKS_URI`
- WS auth (HS256 subprotocol): `JWT_SECRET`
- Redis TLS: `REDIS_URL=rediss://...`, `REDIS_CA=/path/to/ca.pem`
- Database: `DATABASE_URL`
- Event signing: `SPIRAL_EVENT_SECRET`
- Metrics: `ALLOW_ANONYMOUS_METRICS=false` (default) and protected network; if scraping externally, provide bearer
- WS ports: `CONSCIOUSNESS_PORT=3012`, `WS_PORT=3015`
- Feature flags: enable Phase A (`ENABLE_CONSCIOUSNESS_OS`, `ENABLE_UNIVERSAL_PROTOCOL`, `ENABLE_TRANSCENDENT`), keep Phase B off for pilot

WebSocket endpoints (when `ENABLE_UNIFIED_CONSCIOUSNESS=true`):

- `ws://<host>:3012/consciousness-stream`
- `ws://<host>:3012/health-stream`
- `ws://<host>:3012/goals-stream`
- `ws://<host>:3012/orchestration-stream`

WS auth:

- Recommended: subprotocol carries HS256 token generated by your IdP/gateway; scope must include `metacog.stream`
- Fallback for tooling: `?token=<JWT>` query param

Sigil router:

- Ensure `DISABLE_SIGIL_ROUTER=false` when `DATABASE_URL` is valid; use `true` only for isolated canaries without DB

SLO / runbook (outline):

- SLOs: API 99.9% 5xx error budget; WS 99.9% connection uptime; p95 API latency < 300ms; WS backpressure drops < 0.1%
- Alerts: auth failures burst, optional module init failures, WS backpressure/rate-limit drops, heap spikes, 5xx anomalies
- On-call: rotation defined; dashboard links; run commands to rotate tokens, restart WS/API gracefully
- Backups: Postgres daily snapshots; Redis ephemeral; config export for Grafana/Alertmanager
- Rate-limits: per-route envs (`SIGIL_RATE_LIMIT_*`), WS limits via `WS_RATE_LIMIT/WS_RATE_WINDOW`

### Secrets managers (optional scripts)

- GCP Secret Manager
  - Set environment `PROJECT_ID` and run:
    - `/opt/featherweight/scripts/secrets/fetch-gsm.sh`
  - This writes `/opt/featherweight/deploy/secrets.env` which you can source before restarting services:
    - `set -a && source /opt/featherweight/deploy/secrets.env && set +a`

- AWS Secrets Manager
  - Set environment `AWS_REGION` and run:
    - `/opt/featherweight/scripts/secrets/fetch-aws-sm.sh`
  - Same output flow as above (`deploy/secrets.env`).
# 🕊️ Featherweight – A Private AI Companion for Emotional Wellness

[![Test Suite](https://github.com/featherweight/featherweight/actions/workflows/test.yml/badge.svg)](https://github.com/featherweight/featherweight/actions/workflows/test.yml)
[![Coverage](https://img.shields.io/badge/coverage-65%25-yellow)](https://github.com/featherweight/featherweight/actions/workflows/test.yml)
[![Security](https://github.com/featherweight/featherweight/actions/workflows/security-and-quality.yml/badge.svg)](https://github.com/featherweight/featherweight/actions/workflows/security-and-quality.yml)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Node.js](https://img.shields.io/badge/node-%3E%3D18.0.0-brightgreen)](package.json)

Featherweight is a lightweight journaling and conversation assistant powered by uncensored large language models. It’s designed to help users reflect, heal, and grow — with privacy, personality, and emotional depth at its core.

Flappy, the companion at the heart of Featherweight, is a mystical, emotionally intelligent character trained on therapeutic practices and user memory. It evolves with the user and appears across platforms: web, email, SMS, and eventually physical plush toys and mobile apps.

---

## ✨ Key Features

### 🧠 AI-Powered Emotional Journaling
- Flappy engages users in conversation and transforms those dialogues into organized journal entries.
- Uses **Llama-3.1-405B** for high-context inference, emotional tone tracking, and memory awareness.
- Journaling entries are stored securely and can be accessed or continued via multiple channels.

### 📬 Multi-Channel Access
- Flappy can communicate with users through:
  - Web interface
  - SMS (Twilio integration)
  - Email (SendGrid SMTP integration)
- Mobile app (iOS & Android) is currently in development.

### 🧸 Flappy Plush Prototype (In Progress)
- Connected Bluetooth/WiFi plush that allows users to talk to Flappy physically.
- Responds with speech synthesized from Venice-powered LLM responses.
- Emotional LED expressions and contextual replies in sync with the mobile app.

### 🪙 Pet Evolution & Token Integration (Coming)
- Companion evolution based on journaling streaks, on-chain interaction, and XP.
- Solana-based token (FVW) will power the reputation, governance, and staking ecosystem.
- XP events (journaling, wallet actions) influence pet appearance and Flappy’s interaction logic.

---

## 🔧 Bug Fixes (June 2025)

Recent critical improvements:

### ✅ Email Conversation Context
- Replaced generic replies with AI-powered, contextual back-and-forth using `emailConversation` content type.
- Threading headers (`In-Reply-To`, `References`) now maintain proper flow.

### ✅ SMS Memory & Tone
- Full conversation history is now passed during SMS replies.
- Prompt generation respects tone and previous interactions.

### ✅ Prompt Generation Fixes
- Missing `emailConversation` case added to ensure correct behavior across formats.

### ✅ Storage & Threading
- Fixed conversation metadata and ID consistency.
- Conversations now persist and evolve properly across all channels.

📂 Key files modified:
- `/server/email.ts`
- `/server/openai.ts`
- `/server/twilio.ts`

---

## 🧪 Tech Stack

- **LLM:** Llama-3.1-405B via Venice API
- **Backend:** Node.js + pnpm + Express
- **Frontend:** React (Replit-hosted)
- **Database:** Supabase (Postgres)
- **Integrations:** Twilio (SMS), SendGrid (Email), Venice API (LLM Inference)

---

## 🛠️ Currently In Development

- Mobile app UX (iOS/Android)
- Flappy plush speaker + LED prototype
- Solana FVW token drop via Candle & Raydium
- Flappy & Friends YouTube pilot
- Community soul-circle experience w/ live journaling

---

## 📌 Expected Behavior (Post-Bug Fixes)

- **Email & SMS**: Flappy now holds full conversations with memory across replies.
- **Conversations**: Properly saved, threaded, and associated with journal logs.
- **AI**: Richer, more personalized output across every channel.

---

## 👥 Join the Mission

Featherweight is a new kind of AI wellness product — one that listens more than it speaks. Whether you’re a developer, emotional tech thinker, or community organizer, we’re building this space for (and with) real people.

More to come soon.

---

## 🧪 Development & Testing

### Prerequisites
- Node.js ≥18.0.0
- Redis (for full test suite)
- npm or yarn

### Installation
```bash
git clone https://github.com/featherweight/featherweight.git
cd featherweight
npm install
```

### Running Tests
```bash
# Run all tests
npm test

# Run with coverage (requires ≥80% to pass)
npm test -- --coverage

# Run specific test suites
npm test __tests__/spiral/          # Spiral memory tests
npm test __tests__/storage/         # Storage adapter tests

# Verify coverage threshold
npm run verify-coverage

# Run tests with Redis (for full adapter testing)
TEST_REDIS_URL=redis://localhost:6379/15 npm test
```

### Coverage Requirements
- **Minimum Coverage**: 80% (lines, statements, functions, branches)
- **Scope**: `FlappyJournal/server/consciousness/core/**`
- **CI Enforcement**: Builds fail if coverage drops below threshold
- **Reports**: Generated in `coverage/` directory

### Storage Adapter Contract
All storage adapters must pass the contract test suite:
```bash
npm test __tests__/storage/adapterContract.spec.ts
```

Adding a new adapter? Run `npm test storage` - it must pass the contract.

### Spiral Memory Architecture
The consciousness core includes comprehensive test coverage:
- Unit tests for memory storage and retrieval
- Concurrency safety validation
- Garbage collection testing
- Statistics rebuilding verification

---

## Running Locally with Docker

```bash
cp .env.docker.example .env.docker  # then edit if needed
docker compose up --build
# or include monitoring containers
docker compose --profile monitoring up --build
```

## 📚 Additional Documentation

- [Self-Coding API](docs/self-coding-API.md)
- [Deployment Guide](docs/deployment-guide.md)

## 🧬 License

MIT for open-source logic components. Proprietary assets like Flappy IP and the plush toy designs are developed and held under the August9teen creative studio.

---

## Operations: SLOs, Alerts, and Runbook

### Service Level Objectives (SLOs)
- API availability: 99.9% monthly; 5xx error budget ≤ 0.1%
- API latency: p95 ≤ 300ms, p99 ≤ 800ms (excluding client/network errors)
- WebSocket uptime: 99.9% monthly; reconnect within 5s (client)
- WebSocket stability: backpressure drop rate < 0.1% over 1h windows
- Optional modules init failures: 0 sustained for >10m

### Golden Signals & Dashboards
- Dashboard: Consciousness System – Staging (Grafana)
  - Requests, 5xx, latency per route
  - WS connections, messages in/out, drops, errors
  - Module init failures, process memory, GC pauses
  - Quantum/Resonance/Phase A request and error rates

### Alerting (Prometheus/Alertmanager)
- High 5xx rate (per route, per tenant)
- Auth failures burst (JWT invalid/expired)
- Rate-limit drops sustained > 2m
- WS backpressure drops > 0.5% 5m P95
- Optional module init failure > 0 in 5m
- Heap usage > 80% for 10m
- Ready/Liveness failing

See `deploy/prometheus/alerts/selfcoding_rules.yml` for concrete rules.

### Tokens & Auth Runbook
- API (RS256): JWKS-driven; rotate keys at IdP, no server restart required.
- WS (HS256): `JWT_SECRET`; rotate by dual-publishing secrets and staggering client reconnects.
- Metrics: `Authorization: Bearer <METRICS_BEARER_TOKEN>`; rotate via env and Grafana/Prometheus scrape config.

### Rate Limits
- API: per-route via `SIGIL_RATE_LIMIT_*` and `SIGIL_RATE_WINDOW_*` envs; defaults in `index.cjs`.
- WS: configure client send rates; server counters exported via `/metrics`.

### Backups
- Postgres: daily cron 03:17 UTC dumping `sigil_staging` → `/var/backups/featherweight/postgres/` (14-day retention).
  - Script: `/opt/featherweight/scripts/backup/postgres-daily.sh`
  - Verify: `ls -lh /var/backups/featherweight/postgres/`
- Redis: ephemeral; persistence not required for rate limiting.

### Logs & Rotation
- Pino JSON logs; pm2-logrotate: 10MB, retain 14 days, compress.
- Change via `pm2 set pm2-logrotate:*`.

### Health & Readiness
- `/healthz`: process/module status
- `/readyz`: DB + signing + deps
- Unified WS: heartbeat panel on dashboard

### Common Ops Tasks
- Restart API/WS with env reload: `pm2 restart fw-api --update-env && pm2 restart fw-ws --update-env`
- Rotate metrics token: update env, reload Prometheus scrape, notify Grafana
- Validate JWT: `scripts/dev/gen-jwks-and-token.cjs` (dev only)

### Incident Playbooks
- High 5xx:
  - Check `/metrics` for error counters; inspect logs by route
  - Roll back recent deploy; verify DB/Redis health
- Auth failures burst:
  - Validate JWKS reachability, token exp
  - Regenerate test tokens; inspect clock skew
- WS instability:
  - Check backpressure and message rates; reduce client rate; verify Nginx proxy pass headers

### Change Management
- Canary flags: `ENABLE_*` envs
- Promote after 24h soak without SLO violations
- Document changes in `monitoring/grafana/README.md` and `monitoring/prometheus/README.md`
